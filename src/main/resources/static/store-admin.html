<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>매장 관리 도구</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 24px;
      background: #111418;
      color: #f2f4f7;
      line-height: 1.5;
    }
    h1, h2 {
      margin: 0 0 12px;
      font-weight: 600;
    }
    p {
      margin: 0 0 8px;
    }
    section {
      border: 1px solid #2a2f36;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      background: #181c22;
    }
    label {
      font-size: 0.9rem;
      font-weight: 500;
      display: block;
      margin-top: 12px;
    }
    input, textarea, select {
      width: 100%;
      margin-top: 4px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #3a404a;
      background: #0f1318;
      color: #f8fafc;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 64px;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    button {
      margin-top: 16px;
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      background: #4f7df0;
      color: #fff;
    }
    button.secondary {
      background: #2f3847;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #log {
      min-height: 160px;
      background: #050608;
      padding: 12px;
      border-radius: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      overflow-y: auto;
      white-space: pre-wrap;
      max-height: 320px;
    }
    .flex {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .flex input {
      flex: 1 1 auto;
    }
    #store-image-box {
      margin-top: 12px;
      display: none;
    }
    #store-image-box img {
      max-width: 320px;
      border-radius: 8px;
      border: 1px solid #2a2f36;
    }
    .hint {
      font-size: 0.85rem;
      color: #a0aec0;
    }
    hr {
      border: none;
      border-top: 1px solid #2a2f36;
      margin: 16px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>매장 정보 관리 / 이미지 업로드</h1>
    <p class="hint">Access Token으로 인증되는 사장 전용 API를 바로 호출할 수 있는 도구입니다.</p>
  </header>

  <section id="config">
    <h2>환경 설정</h2>
    <div class="row">
      <label>
        API Base URL
        <input id="base-url" value="http://localhost:8080">
      </label>
      <label>
        Access Token (Bearer)
        <input id="access-token" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." autocomplete="off">
      </label>
    </div>
    <button class="secondary" onclick="applyConfig()">설정 적용</button>
  </section>

  <section id="store-create">
    <h2>매장 생성</h2>
    <form id="create-form">
      <div class="row">
        <label>매장명
          <input name="name" required>
        </label>
        <label>카테고리
          <input name="category" value="요식업" required>
        </label>
        <label>매장 전화번호
          <input name="phone" placeholder="0507-XXXX-XXXX" required>
        </label>
        <label>도로명 주소
          <input name="addressRoad" required>
        </label>
      </div>
      <div class="row">
        <label>위도
          <input name="lat" type="number" step="0.000001" required>
        </label>
        <label>경도
          <input name="lon" type="number" step="0.000001" required>
        </label>
        <label>오픈 시간
          <input name="openTime" type="time" required>
        </label>
        <label>마감 시간
          <input name="closeTime" type="time" required>
        </label>
      </div>
      <label>매장 소개
        <textarea name="description" placeholder="매장 소개 문구를 입력하세요."></textarea>
      </label>
      <button type="submit">매장 생성</button>
    </form>
    <p class="hint">응답에 포함된 ID를 아래 업데이트/이미지 업로드 섹션에서 사용하세요.</p>
  </section>

  <section id="store-update">
    <h2>매장 수정</h2>
    <form id="update-form">
      <label>매장 ID
        <input name="storeId" placeholder="UUID 형식" required>
      </label>
      <div class="row">
        <label>매장명
          <input name="name">
        </label>
        <label>카테고리
          <input name="category">
        </label>
        <label>매장 전화번호
          <input name="phone" placeholder="0507-XXXX-XXXX">
        </label>
        <label>도로명 주소
          <input name="addressRoad">
        </label>
      </div>
      <div class="row">
        <label>위도
          <input name="lat" type="number" step="0.000001">
        </label>
        <label>경도
          <input name="lon" type="number" step="0.000001">
        </label>
        <label>오픈 시간
          <input name="openTime" type="time">
        </label>
        <label>마감 시간
          <input name="closeTime" type="time">
        </label>
      </div>
      <label>매장 소개
        <textarea name="description" placeholder="변경 시에만 입력"></textarea>
      </label>
      <label>이미지 Key (선택)
        <input name="imageKey">
      </label>
      <div class="row">
        <label>이미지 MIME
          <input name="imageMime" placeholder="image/png">
        </label>
        <label>이미지 ETag
          <input name="imageEtag" placeholder="S3 업로드 후 확인값">
        </label>
      </div>
      <button type="submit" class="secondary">매장 정보 수정</button>
    </form>
  </section>

  <section id="store-read">
    <h2>매장 조회</h2>
    <form id="fetch-form" class="flex">
      <input name="storeId" placeholder="UUID" required>
      <button type="submit" class="secondary">매장 정보 불러오기</button>
    </form>
    <p class="hint">조회 결과는 아래에 JSON으로 표시되고, 수정 폼에도 자동 반영됩니다.</p>
    <pre id="store-result"></pre>
    <div id="store-image-box">
      <p class="hint">현재 등록된 매장 이미지</p>
      <img id="store-image" alt="매장 이미지 미리보기">
    </div>
  </section>

  <section id="image-upload">
    <h2>매장 이미지 업로드</h2>
    <p class="hint">1) Presign 발급 → 2) S3 PUT → 3) 서버 confirm → 4) 자동으로 매장 이미지 메타 갱신</p>
    <div class="row">
      <label>매장 ID
        <input id="upload-store-id" placeholder="UUID" required>
      </label>
      <label>이미지 파일
        <input id="upload-file" type="file" accept="image/*">
      </label>
    </div>
    <button onclick="handleImageUpload()">이미지 업로드 실행</button>
  </section>

  <section id="log-section">
    <h2>로그</h2>
    <div id="log"></div>
  </section>

  <script>
    const state = {
      baseUrl: document.getElementById("base-url").value.trim(),
      token: "",
    };

    function applyConfig() {
      state.baseUrl = document.getElementById("base-url").value.trim().replace(/\/$/, "");
      state.token = document.getElementById("access-token").value.trim();
      appendLog("환경 설정이 적용되었습니다.");
    }

    function appendLog(message, payload) {
      const log = document.getElementById("log");
      const ts = new Date().toLocaleTimeString();
      let text = `[${ts}] ${message}`;
      if (payload !== undefined) {
        text += "\\n" + JSON.stringify(payload, null, 2);
      }
      log.textContent = text + "\\n\\n" + log.textContent;
    }

    function authHeaders() {
      if (!state.token) {
        throw new Error("Access Token을 먼저 입력하세요.");
      }
      return {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${state.token}`,
      };
    }

    async function handleCreate(event) {
      event.preventDefault();
      try {
        const form = event.target;
        const payload = {
          name: form.name.value.trim(),
          category: form.category.value.trim(),
          phone: form.phone.value.trim(),
          addressRoad: form.addressRoad.value.trim(),
          lat: Number(form.lat.value),
          lon: Number(form.lon.value),
          openTime: form.openTime.value,
          closeTime: form.closeTime.value,
          description: form.description.value.trim() || null,
          imageKey: null,
          imageMime: null,
          imageEtag: null,
        };
        appendLog("매장 생성 요청", payload);
        const res = await fetch(`${state.baseUrl}/v1/api/stores`, {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify(payload),
        });
        const body = await res.json();
        appendLog("매장 생성 응답", body);
        if (body?.success && body?.data?.id) {
          document.querySelector("#update-form [name='storeId']").value = body.data.id;
          document.getElementById("upload-store-id").value = body.data.id;
        }
      } catch (err) {
        appendLog("매장 생성 실패", { error: err.message });
      }
    }

    async function handleUpdate(event) {
      event.preventDefault();
      const form = event.target;
      const storeId = form.storeId.value.trim();
      if (!storeId) {
        appendLog("매장 ID를 입력하세요.");
        return;
      }
      try {
        const payload = {
          name: form.name.value.trim() || null,
          category: form.category.value.trim() || null,
          phone: form.phone.value.trim() || null,
          addressRoad: form.addressRoad.value.trim() || null,
          lat: form.lat.value ? Number(form.lat.value) : null,
          lon: form.lon.value ? Number(form.lon.value) : null,
          openTime: form.openTime.value || null,
          closeTime: form.closeTime.value || null,
          description: form.description.value.trim() || null,
          imageKey: form.imageKey.value.trim() || null,
          imageMime: form.imageMime.value.trim() || null,
          imageEtag: form.imageEtag.value.trim() || null,
        };
        appendLog("매장 수정 요청", { storeId, payload });
        const res = await fetch(`${state.baseUrl}/api/v1/stores/${storeId}`, {
          method: "PATCH",
          headers: authHeaders(),
          body: JSON.stringify(payload),
        });
        const body = await res.json();
        appendLog("매장 수정 응답", body);
      } catch (err) {
        appendLog("매장 수정 실패", { error: err.message });
      }
    }

    async function handleImageUpload() {
      const storeId = document.getElementById("upload-store-id").value.trim();
      const fileInput = document.getElementById("upload-file");
      const file = fileInput.files[0];
      if (!storeId || !file) {
        appendLog("매장 ID와 이미지를 모두 선택하세요.");
        return;
      }
      try {
        appendLog("Presign 요청 시작", { fileName: file.name, type: file.type });
        const presignRes = await fetch(`${state.baseUrl}/api/v1/stores/${storeId}/uploads/presign`, {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({
            fileName: file.name,
            contentType: file.type || "application/octet-stream",
          }),
        });
        const presignBody = await presignRes.json();
        appendLog("Presign 응답", presignBody);
        if (!presignBody.success) throw new Error("Presign 실패");
        const { url, key } = presignBody.data;

        appendLog("S3 업로드 시작");
        const putRes = await fetch(url, {
          method: "PUT",
          headers: {
            "Content-Type": file.type || "application/octet-stream",
          },
          body: file,
        });
        if (!putRes.ok) {
          throw new Error(`S3 업로드 실패: ${putRes.status}`);
        }
        let etag = putRes.headers.get("ETag") || putRes.headers.get("etag");
        if (etag) {
          etag = etag.replace(/"/g, "");
        } else {
          appendLog("ETag 헤더를 찾지 못했습니다. S3 설정을 확인하세요.");
          throw new Error("ETag 헤더 누락");
        }
        appendLog("S3 업로드 완료", { key, etag });

        appendLog("업로드 Confirm 호출");
        const confirmRes = await fetch(`${state.baseUrl}/api/v1/stores/${storeId}/uploads/confirm`, {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ key, etag }),
        });
        const confirmBody = await confirmRes.json();
        appendLog("Confirm 응답", confirmBody);
        if (!confirmBody.success) {
          throw new Error("Confirm 실패");
        }

        const metadata = confirmBody.data;
        document.querySelector("#update-form [name='imageKey']").value = metadata.key;
        document.querySelector("#update-form [name='imageMime']").value = metadata.contentType;
        document.querySelector("#update-form [name='imageEtag']").value = metadata.etag;

        appendLog("매장 이미지 정보 업데이트 호출");
        const patchRes = await fetch(`${state.baseUrl}/v1/api/stores/${storeId}`, {
          method: "PATCH",
          headers: authHeaders(),
          body: JSON.stringify({
            imageKey: metadata.key,
            imageMime: metadata.contentType,
            imageEtag: metadata.etag,
          }),
        });
        const patchBody = await patchRes.json();
        appendLog("이미지 정보 업데이트 응답", patchBody);
        if (patchBody?.success) {
          loadStoreImage(storeId);
        }
      } catch (err) {
        appendLog("이미지 업로드 실패", { error: err.message });
      }
    }

    document.getElementById("create-form").addEventListener("submit", handleCreate);
    document.getElementById("update-form").addEventListener("submit", handleUpdate);
    document.getElementById("fetch-form").addEventListener("submit", handleFetch);

    async function handleFetch(event) {
      event.preventDefault();
      const form = event.target;
      const storeId = form.storeId.value.trim();
      if (!storeId) {
        appendLog("조회할 매장 ID를 입력하세요.");
        return;
      }
      try {
        appendLog("매장 조회 요청", { storeId });
        const res = await fetch(`${state.baseUrl}/v1/api/stores/${storeId}`, {
          method: "GET",
          headers: authHeaders(),
        });
        const body = await res.json();
        appendLog("매장 조회 응답", body);
        document.getElementById("store-result").textContent = JSON.stringify(body, null, 2);
        if (body?.success && body?.data) {
          populateUpdateForm(body.data);
        }
      } catch (err) {
        appendLog("매장 조회 실패", { error: err.message });
        document.getElementById("store-result").textContent = err.message;
      }
    }

function populateUpdateForm(data) {
  const updateForm = document.getElementById("update-form");
  updateForm.storeId.value = data.id || "";
      updateForm.name.value = data.name || "";
      updateForm.category.value = data.category || "";
      updateForm.phone.value = data.phone || "";
      updateForm.addressRoad.value = data.addressRoad || "";
      updateForm.lat.value = data.lat ?? "";
      updateForm.lon.value = data.lon ?? "";
      updateForm.openTime.value = formatTimeInput(data.openTime);
      updateForm.closeTime.value = formatTimeInput(data.closeTime);
      updateForm.description.value = data.description || "";
      updateForm.imageKey.value = data.imageKey || "";
      updateForm.imageMime.value = data.imageMime || "";
      updateForm.imageEtag.value = data.imageEtag || "";
  document.getElementById("upload-store-id").value = data.id || "";
  const fetchInput = document.querySelector("#fetch-form input[name='storeId']");
  if (fetchInput) fetchInput.value = data.id || "";
  if (data.imageKey) {
    loadStoreImage(data.id);
  } else {
    hideStoreImage();
  }
}

function formatTimeInput(value) {
  if (!value) return "";
  return value.slice(0, 5);
}

async function loadStoreImage(storeId) {
  if (!storeId) {
    hideStoreImage();
    return;
  }
  try {
    const res = await fetch(`${state.baseUrl}/api/v1/stores/${storeId}/uploads/view`, {
      method: "GET",
      headers: authHeaders(),
    });
    const body = await res.json();
    if (body?.success && body?.data?.url) {
      const img = document.getElementById("store-image");
      img.src = body.data.url;
      document.getElementById("store-image-box").style.display = "block";
    } else {
      hideStoreImage();
    }
  } catch (err) {
    appendLog("이미지 URL 발급 실패", { error: err.message });
    hideStoreImage();
  }
}

function hideStoreImage() {
  const img = document.getElementById("store-image");
  img.removeAttribute("src");
  document.getElementById("store-image-box").style.display = "none";
}
  </script>
</body>
</html>
